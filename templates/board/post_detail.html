{% extends "layout/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}
  {{ post.title }} - 뭐입지?
{% endblock title %}

{% block head %}
    {% include "layout/head.html" %}
{% endblock head %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/board.css' %}">
{% endblock extra_css %}

{% block navi %}
  {% include "layout/navbar.html" %}
{% endblock navi %}

{% block content %}
    <!-- 게시글 -->
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="d-flex align-items-center gap-2">
                <h2 class="text-muted post-category">[{{ post.category }}]</h2>
                <h2>{{ post.title }}</h2>
            </div>
            <div class="d-flex align-items-center gap-2">
                {% if request.user == post.author %}
                    <a href="{% url 'board:post_update' post.id %}" class="btn btn-custom-green">수정</a>
                    <a href="{% url 'board:post_delete' post.id %}" class="btn btn-custom-red">삭제</a>
                {% endif %}
                <a href="{% url 'board:post_list' %}" class="btn btn-custom-gray">목록</a>
            </div>
        </div>
    

        <div class="text-muted mb-2 pb-3">
            {{ post.author.username }}
            {% if profile %}
                (
                {% if profile.cold_sensitivity %}
                    🥶{{ profile.cold_sensitivity }}
                {% endif %}
                {% if profile.heat_sensitivity %}
                    🥵{{ profile.heat_sensitivity }}
                {% endif %}
                )
            {% endif %} 
            /
            {% if post.updated_at != post.created_at %}
                {{ post.updated_at|custom_time }} (수정)
            {% else %}
                {{ post.created_at|custom_time }}
            {% endif %}
        </div>

        <p>{{ post.content }}</p>

        <div class="d-flex flex-wrap gap-3 mt-4">
            {% for image in images %}
            <img src="{{ image.image.url }}" class="post-image rounded">
            {% empty %}
            <!--<p class="text-muted">첨부된 이미지가 없습니다.</p>-->
            {% endfor %}
        </div>

        <form method="post" action="{% url 'board:post_like' post.id %}" class="d-inline">
            {% csrf_token %}
            {% if not user.is_authenticated or request.user == post.author %}
                <button type="submit" class="btn btn-outline-secondary" disabled>
                    추천 {{ post.likes.count }}
                </button>
            {% else %}
                <button type="submit" class="btn btn-outline-primary">
                    추천 {{ post.likes.count }}
                </button>
            {% endif %}
        </form>

        <form method="post" action="{% url 'board:post_scrap' post.id %}" style="display: inline;">
            {% csrf_token %}
            {% if not user.is_authenticated or request.user == post.author %}
                <button type="submit" class="btn btn-outline-secondary" disabled>
                    스크랩 {{ post.scraps.count }}
                </button>
            {% else %}
                <button type="submit" class="btn btn-outline-warning">
                    스크랩 {{ post.scraps.count }}
                </button>
            {% endif %}
        </form>

        <!-- 댓글 -->
        <div class="comment-section">
            <h5>{{ post.comments.count }}개의 댓글이 있습니다.</h5>

            <div class="mt-3">              
                <form method="post" enctype="multipart/form-data" action="{% url 'board:comment_create' post.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea name="content" class="form-control" rows="3" placeholder="댓글을 입력하세요."></textarea>
                    </div>

                    <div class="mb-3">
                        <input type="file" name="image" id="commentImage" class="form-control" accept="image/*">
                    </div>

                    <div class="mb-3">
                        <img id="preview" src="#" alt="미리보기" class="comment-preview-img">
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="submit" class="btn btn-custom-blue mb-3">등록</button>
                    </div>
                </form>
            </div>

            {% for comment in comments %}
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>
                            {{ comment.author.username }}
                            {% with comment_profiles|get_item:comment.id as cp %}
                                {% if cp %}
                                    (
                                    {% if cp.cold_sensitivity %}
                                        🥶{{ cp.cold_sensitivity }}
                                    {% endif %}
                                    {% if cp.heat_sensitivity %}
                                        🥵{{ cp.heat_sensitivity }}
                                    {% endif %}
                                    )
                                {% endif %}
                            {% endwith %}
                        </strong> 
                        <div class="d-flex flex-column">
                            <small class="text-muted">{{ comment.created_at|custom_time }}</small>
                            {% if comment.updated_at != comment.created_at %}
                                <small class="text-muted">{{ comment.updated_at|custom_time }} (수정)</small>
                            {% endif %}
                        </div>
                    </div>

                    <div>{{ comment.content }}</div>

                    {% if comment.image %}
                        <div class="mt-2">
                            <img src="{{ comment.image.url }}" class="comment-image rounded">
                        </div>
                    {% endif %}

                    {% if request.user == comment.author %}
                        <div class="d-flex justify-content-end gap-2 mt-2">
                            <a href="{% url 'board:comment_update' comment.id %}" class="btn btn-custom-green btn-sm">수정</a>
                            <a href="{% url 'board:comment_delete' comment.id %}" class="btn btn-custom-red btn-sm">삭제</a>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p class="text-muted">아직 댓글이 없습니다.</p>
            {% endfor %}
        </div>
    </div>
{% endblock content %}

{% block footer %}
  {% include "layout/footer.html" %}
{% endblock footer %}

{% block script %}
    <script>
        document.getElementById('commentImage').addEventListener('change', function(event) {
            var preview = document.getElementById('preview');
            var file = event.target.files[0];

            if (file) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };

                reader.readAsDataURL(file);
            } else {
                preview.src = "#";
                preview.style.display = 'none';
            }
        });
    </script>
{% endblock script %}