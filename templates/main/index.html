{% extends "layout/base.html" %}
{% load static %}

{% block title %}
  í™ˆ - ë­ì…ì§€?
{% endblock title %}

{% block head %}
  {% include "layout/head.html" %}
{% endblock head %}

{% block navi %}
  {% include "layout/navbar.html" %}
{% endblock navi %}

{% block content %}
  <div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <h4 class="m-0">ë‚ ì”¨</h4>
      <div class="d-flex gap-2">
        <select class="form-select w-auto" id="sido-select"></select>
        <select class="form-select w-auto" id="sigungu-select"></select>
        <select class="form-select w-auto" id="dong-select"></select>
        <button class="btn btn-primary">ê²€ìƒ‰</button>
      </div>
    </div>

    <div id="weather-words" class="text-center mb-5 text-muted" style="font-size: 20px;">
      ì˜¤ëŠ˜ì€ ì–´ì œë³´ë‹¤ ë‚® ê¸°ì˜¨ì´ 10ë„ ë†’ê³  ë”°ëœ»í•œ ë‚ ì´ì—ìš”. ê°€ë²¼ìš´ ì˜·ì°¨ë¦¼ ì¶”ì²œë“œë ¤ìš”!
    </div>

    <div class="d-flex justify-content-center align-items-center mb-5 pt-4">
      <button id="btn-prev" class="btn btn-outline-secondary me-2">&lt;</button>
      <div id="weather-cards" class="d-flex flex-row gap-4"></div>
      <button id="btn-next" class="btn btn-outline-secondary ms-2">&gt;</button>
    </div>

    <div id="daily-summary" class="d-flex justify-content-center flex-wrap gap-3 mt-5 pt-4">
      <!-- JSë¡œ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
    </div>
  </div>
{% endblock content %}

{% block footer %}
  {% include "layout/footer.html" %}
{% endblock footer %}

{% block script %}
  <!-- í…œí”Œë¦¿ì—ì„œ ì „ì—­ìœ¼ë¡œ ì„¤ì •í•  ê°’ì€ ëª¨ë“ˆ ë°–ì—ì„œ ë¨¼ì € ì„ ì–¸í•´ì•¼ ì•ˆì „ -->
  <script>
    window.NAVER_CLIENT_ID = "{{ naver_client_id }}";
    window.NAVER_CLIENT_SECRET = "{{ naver_client_secret }}";
    window.KMA_SHORT_ENDPOINT = "{{ kma_short_endpoint }}";
    window.KMA_SHORT_KEY = "{{ kma_short_key }}";
    window.KMA_MID_ENDPOINT = "{{ kma_mid_endpoint }}";
    window.KMA_MID_KEY = "{{ kma_mid_key }}";
  </script>

  <script type="module">
  // í•„ìš”í•œ ëª¨ë“ˆ import
  import { convertToGrid } from "{% static 'js/utils/convertToGrid.js' %}";
  import { getWeatherForecast } from "{% static 'js/weather.js' %}";

  // ìš”ì¼ ë¦¬ìŠ¤íŠ¸ ìƒì„± (ì˜¤ëŠ˜ ê¸°ì¤€ +1~+6ì¼)
  const now = new Date();
  const daysOfWeek = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  const today = now.getDay();
  const days = Array.from({ length: 6 }, (_, i) => daysOfWeek[(today + i + 1) % 7]);


  // ìŠ¬ë¼ì´ë“œ ê´€ë ¨ ì„¤ì •ê°’
  let startIndex = 0;
  const visibleCount = 6;

  const container = document.getElementById("weather-cards");
  const btnPrev = document.getElementById("btn-prev");
  const btnNext = document.getElementById("btn-next");

  // ë‚ ì”¨ ë°ì´í„° ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸ (APIë¡œ ë°›ì•„ì˜¨ ê²°ê³¼ë¥¼ ë‹´ì„ ê³³)
  let weatherData = [];

  // ì‹œê°„ë³„ ë‚ ì”¨ ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜
  function renderCards() {
    container.innerHTML = "";
    const sliced = weatherData.slice(startIndex, startIndex + visibleCount);
    sliced.forEach(item => {
      const card = document.createElement("div");
      card.className = "text-center border rounded shadow-sm p-4 bg-light";
      card.style.minWidth = "120px";
      card.style.height = "140px";
      card.innerHTML = `
        <div style="font-size: 32px;">${item.icon}</div>
        <div style="font-size: 18px;">${item.temp}</div>
        <div style="font-size: 16px;">${item.hour}</div>
      `;
      container.appendChild(card);
    });

    btnPrev.disabled = startIndex === 0;
    btnNext.disabled = startIndex + visibleCount >= weatherData.length;
  }

  window.renderCards = renderCards;

  //  ì´ì „ ë²„íŠ¼
  btnPrev.addEventListener("click", () => {
    if (startIndex > 0) {
      startIndex -= 1;
      renderCards();
    }
  });

  //  ë‹¤ìŒ ë²„íŠ¼
  btnNext.addEventListener("click", () => {
    if (startIndex + visibleCount < weatherData.length) {
      startIndex += 1;
      renderCards();
    }
  });

  // ìš”ì¼ ìš”ì•½ ë‚ ì”¨ ë°•ìŠ¤ ë Œë”ë§
  function renderDailySummary() {
    const container = document.getElementById("daily-summary");
    container.innerHTML = "";

    days.forEach(day => {
      const div = document.createElement("div");
      div.className = "border rounded p-3 text-center";
      div.style.width = "140px";
      div.innerHTML = `
        <div style="font-weight: bold;">${day}ìš”ì¼</div>
        <div style="font-size: 24px;">ğŸŒ¥ï¸</div>
        <div>ìµœê³  18Â°C</div>
        <div>ìµœì € 9Â°C</div>
      `;
      container.appendChild(div);
    });
  }

  // í˜ì´ì§€ ë¡œë”© ì‹œ: ì£¼ì†Œ json ë¶ˆëŸ¬ì˜¤ê¸° + ìš”ì•½ ë‚ ì”¨ ë Œë”ë§ë§Œ ì‹¤í–‰
  document.addEventListener("DOMContentLoaded", () => {
    fetch("/static/json/address_data.json")
      .then((response) => response.json())
      .then((data) => {
        console.log("ì£¼ì†Œ ë°ì´í„°:", data);
      })
      .catch((error) => {
        console.error("ì£¼ì†Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
      });

    renderDailySummary();    // ìš”ì¼ ìš”ì•½ ë‚ ì”¨ ë Œë”ë§
  });

  // ì‚¬ìš©ìì˜ ìœ„ë„, ê²½ë„ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      // ìœ„ë„, ê²½ë„ë¥¼ ë™ ë‹¨ìœ„ ì£¼ì†Œë¡œ ë³€ê²½ (ë„¤ì´ë²„ API)
      fetch(`/get-address?lat=${lat}&lon=${lon}`)
        .then(response => response.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            const dong = data.results[0].region.area3.name;
            document.querySelector("h4").textContent = `${dong} ë‚ ì”¨`;
          }
        });

      // ìœ„ë„, ê²½ë„ë¥¼ ê¸°ìƒì²­ìš© ê²©ì ì¢Œí‘œë¡œ ë³€í™˜
      const { x, y } = convertToGrid(lat, lon);

      // getWeatherForecastê°€ ê²°ê³¼ë¥¼ return ë˜ëŠ” ì½œë°±ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” êµ¬ì¡°ë¼ê³  ê°€ì •í•˜ê³  ì‚¬ìš©
      getWeatherForecast(
        x,
        y,
        `${window.KMA_SHORT_ENDPOINT}/getVilageFcst`,
        window.KMA_SHORT_KEY,
        `${window.KMA_MID_ENDPOINT}/getMidTa`,
        window.KMA_MID_KEY,
        function(result) {
          // ë°›ì•„ì˜¨ ë°ì´í„° ì €ì¥í•˜ê³  ë Œë”ë§
          weatherData = result;
          renderCards();
        }
      );

    },
    function(error) {
      console.error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", error);
    }
  );


</script>

{% endblock script %}
